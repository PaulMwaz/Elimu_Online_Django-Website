# ---- Build React (Vite) ----
FROM node:20-alpine AS build
WORKDIR /app
# install deps
COPY client/package*.json ./client/
RUN cd client && npm ci
# copy source and build
COPY client ./client
RUN cd client && npm run build

# ---- Nginx reverse proxy ----
FROM nginx:1.25-alpine
RUN apk add --no-cache gettext  # envsubst for templating
# Copy nginx template and React build output
COPY nginx/default.conf.template /etc/nginx/templates/default.conf.template
COPY --from=build /app/client/dist /usr/share/nginx/html
# Render provides $PORT. We also use BACKEND_HOST/BACKEND_PORT envs.
CMD sh -c 'envsubst < /etc/nginx/templates/default.conf.template > /etc/nginx/conf.d/default.conf && exec nginx -g "daemon off;"'
